<!-- /dashboard 
    Tampilan list menu pada dashboard
-->
<main id="site-main">

    <a class="add-menu">
        +
    </a>

    <div class="dashboard-container">

        <h1><span class="mcd">McD</span>ini's Menu</h1>
        
        <div class="button-container">
            <a class="add-menu-btn">
                    <span class="material-icons-sharp" style="padding-bottom: 2px;">add</span>
                    New Menu
            </a>

            <a class="order-details-btn" href="/dashboard/carts">
                Check Order
                <span class="material-symbols-outlined" style="padding-bottom: 2px; padding-left: 0.4rem;">
                    event_list
                    </span>
            </a>
        </div>

        <form action="/dashboard" method="POST">
            <table class="menu-table">
                <thead>
                    <tr>
                        <th class="sortable">ID</th>
                        <th>Image</th>
                        <th class="sortable">Name</th>
                        <th class="sortable">Price</th>
                        <th class="sortable">Type</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody>
                    <% for(var i=0; i < menu.length; i++) { %>
                    <tr>
                        <td><%= i+1 %></td>
                        <td><img src="<%= menu[i].image %>" width="150px"></td>
                        <td data-name="<%= menu[i].name %>"><%= menu[i].name %></td>
                        <td><%= menu[i].price.toLocaleString() %></td>
                        <td><%= menu[i].type %></td>
                        <td>
                            <div class="menu-modify-btn">
                                <a class="menu-update" update-id="<%= menu[i]._id %>">
                                    <span class="material-icons-sharp">
                                        edit
                                    </span>
                                </a>

                                <a class="menu-delete" data-id="<%= menu[i]._id %>">
                                    <span class="material-icons-sharp">
                                        delete
                                    </span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    <% } %>
                </tbody>
            </table>
        </form>
    </div>

    <div class="delete-menu-container">

        <div class="delete-menu-info">
            <img src="../assets/logo_mcd.png">
            <div class="delete-menu-text">
                <p class="delete-confirm">Are you sure you want to <span class="delete-highlight">delete</span> "Paket Berkah"?</p>
                <p class="delete-info">This item will be deleted immediately. You can't undo this action.</p>
            </div>
        </div>
        
        <div 
            onclick="document.querySelector('.delete-menu-container').style.display = 'none'"
            class="delete-menu-action-btn"
        >

            <a class="delete-btn">
                Delete
            </a>
            
            <a class="cancel-btn">
                Cancel
            </a>

        </div>
    </div>

    <div class="overlay"></div>

    <div class="new-menu-container">

        <div class="new-menu-input">
            <div class="new-menu-pics">
                <label for="input-file" id="drop-area">
                    <input type="file" accept="image/png" id="input-file" hidden>
                    <div id="img-view">
                        <img src="../assets/cloud_upload.svg">
        
                        <p>Drag and drop your image here<br>or<br>Browse to upload image</p>
                        <span>Recommended size: 240 x 180 px (.png)</span>
                    </div>
                </label>
            </div>
            
            <div class="new-menu-details">
                <h2>New Menu</h2>
    
                <form id="add_menus" class="form">
                    <div class="form-group">
                        <label for="name" class="details-title">Name</label><br>
                        <input type="hidden" name="id" value="">
                        <input type="text" name="name" value="" placeholder="Enter the menu's name..." required>
    
                        <div class="nameerror"></div>
                    </div>
    
                    <div class="form-group">
                        <label for="price" class="details-title">Price</label><br>
                        <input type="number" name="price" value="" placeholder="Enter the menu's price..." required>
    
                        <div class="pricerrror"></div>
                    </div>
    
                    <div class="form-group">
                        <label for="type" class="details-title">Type</label><br>
                        <select name="type">
                            <option value="Promotion">Promotion</option>
                            <option value="Ala Carte">Ala Carte</option>
                            <option value="Sides">Sides</option>
                            <option value="Desserts">Desserts</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Cafe">Cafe</option>
                        </select>
    
                        <div class="typerror"></div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="new-menu-btn">
            <a class="save-btn-menu">Save</a>

            <a class="cancel-btn-menu">Cancel</a>
        </div>
    </div>

    <div class="update-menu-container">

        <div class="update-menu-input">
            <div class="update-menu-pics">
                <label for="input-file2" id="view-area">
                    <input type="file" accept="image/png" id="input-file2" hidden>
                    <div id="img-view2">
                    </div>
                </label>
            </div>
            
            <div class="update-menu-details">
                <h2>Update Menu</h2>
    
                <form id="update_menus" class="form">
                    <div class="form-group">
                        <label for="name" class="details-title">Name</label><br>
                        <input type="hidden" name="id2" value="">
                        <input type="text" name="name2" value="" placeholder="Enter the menu's name..." required>
    
                        <div class="nameerror"></div>
                    </div>
    
                    <div class="form-group">
                        <label for="price" class="details-title">Price</label><br>
                        <input type="number" name="price2" value="" placeholder="Enter the menu's price..." required>
    
                        <div class="pricerrror"></div>
                    </div>
    
                    <div class="form-group">
                        <label for="type" class="details-title">Type</label><br>
                        <select name="type2">
                            <option value="Promotion">Promotion</option>
                            <option value="Ala Carte">Ala Carte</option>
                            <option value="Sides">Sides</option>
                            <option value="Desserts">Desserts</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Cafe">Cafe</option>
                        </select>
    
                        <div class="typerror"></div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="update-menu-btn">
            <a class="save-btn-menu2">Save</a>

            <a class="cancel-btn-menu2">Cancel</a>
        </div>
    </div>
</main>

<script>
    /**
     * 
     * @param {HTMLTableElement} table
     * @param {number} column The index of the column to sort
     * @param {boolean} asc Determines if the sorting will be in ascending
     */

    // Sort data table berdasarkan string
    function sortTableByColumn(table, column, asc = true){
        const dirModifier = asc ? 1 : -1;
        const tBody = table.tBodies[0];
        const rows = Array.from(tBody.querySelectorAll("tr"));

        // Sort each row (kalau dia String)
        const sortedRows = rows.sort((a, b) => {
            const aColText = a.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim();
            const bColText = b.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim();

            return aColText > bColText ? (1 * dirModifier) : (-1 * dirModifier);
        });

        // Remove all existing TRs from the table
        while (tBody.firstChild){
            tBody.removeChild(tBody.firstChild);
        }

        // Re-add the newly sorted rows
        tBody.append(...sortedRows);

        // Remember how the column is currently sorted
        table.querySelectorAll("th").forEach(th => th.classList.remove("th-sort-asc", "th-sort-desc"));
        table.querySelector(`th:nth-child(${ column + 1 })`).classList.toggle("th-sort-asc", asc);
        table.querySelector(`th:nth-child(${ column + 1 })`).classList.toggle("th-sort-desc", !asc);
    }

    // Sort data table berdasarkan angka
    function sortTableByColumnNumerical(table, column, asc = true){
        const dirModifier = asc ? 1 : -1;
        const tBody = table.tBodies[0];
        const rows = Array.from(tBody.querySelectorAll("tr"));

        // Sort each row
        const sortedRows = rows.sort((a, b) => {
            const aColText = parseFloat(a.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim());
            const bColText = parseFloat(b.querySelector(`td:nth-child(${ column + 1 })`).textContent.trim());

            // return aColText - bColText; // Perbandingan angka langsung
            return aColText > bColText ? (1 * dirModifier) : (-1 * dirModifier);
        });


        // Remove all existing TRs from the table
        while (tBody.firstChild){
            tBody.removeChild(tBody.firstChild);
        }

        // Re-add the newly sorted rows
        tBody.append(...sortedRows);

        // Remember how the column is currently sorted
        table.querySelectorAll("th").forEach(th => th.classList.remove("th-sort-asc", "th-sort-desc"));
        table.querySelector(`th:nth-child(${ column + 1 })`).classList.toggle("th-sort-asc", asc);
        table.querySelector(`th:nth-child(${ column + 1 })`).classList.toggle("th-sort-desc", !asc);
    }

    // Aktivasi fungsi sorting pada header table
    document.querySelectorAll(".menu-table th").forEach(headerCell => {
        headerCell.addEventListener("click", () => {
            const tableElement = headerCell.parentElement.parentElement.parentElement;
            const headerIndex = Array.prototype.indexOf.call(headerCell.parentElement.children, headerCell);
            const currentIsAscending = headerCell.classList.contains("th-sort-asc");

            if ([2,4].includes(headerIndex)){
                // console.log(headerIndex)
                sortTableByColumn(tableElement, headerIndex, !currentIsAscending);
            }
            if ([0,3].includes(headerIndex)){
                sortTableByColumnNumerical(tableElement, headerIndex, !currentIsAscending);
            }
        });
    })

    // Ketika tombol hapus diklik
    document.querySelectorAll('.menu-delete').forEach(deleteBtn => {
        deleteBtn.addEventListener('click', (e) => {
            e.preventDefault();

            // Dapatkan ID dan nama menu dari data-name atribut pada elemen terkait
            const menuID = e.currentTarget.getAttribute('data-id');
            const menuName = e.currentTarget.closest('tr').querySelector('td[data-name]').dataset.name;

            // Tampilkan nama menu pada pesan konfirmasi penghapusan
            document.querySelector('.delete-confirm').innerHTML = `Are you sure you want to <span class="delete-highlight">delete</span> "${menuName}"?`;

            // Tampilkan overlay
            const overlay = document.querySelector('.overlay');
            overlay.style.top = "0%";
            overlay.style.opacity = "1";
            overlay.classList.add("active");

            // Tampilkan kontainer penghapusan
            var deleteMenuContainer = document.querySelector('.delete-menu-container');
            deleteMenuContainer.style.display = 'block';
            deleteMenuContainer.style.top = '50%';
            deleteMenuContainer.style.transform = 'translate(-50%, -50%)';

            deleteMenuContainer.dataset.menuID = menuID;
        })
    })

    // Event listener untuk tombol pembatalan
    document.querySelector('.cancel-btn').addEventListener('click', () => {
        // Sembunyikan overlay
        const overlay = document.querySelector('.overlay');
        overlay.style.top = "-100%";
        overlay.style.opacity = "0";

        // Sembunyikan kontainer penghapusan
        const deleteMenuContainer = document.querySelector('.delete-menu-container');
        deleteMenuContainer.style.display = '150%';
        deleteMenuContainer.style.transform = 'translate(-50%, -50%)';
        deleteMenuContainer.style.display = 'none';
    });

    // Event listener untuk tombol add-menu-btn
    document.querySelector('.add-menu-btn').addEventListener('click', () => {
        // Tampilkan new-menu-container

        // Tampilkan overlay
        const overlay = document.querySelector('.overlay');
        overlay.style.top = "0%";
        overlay.style.opacity = "1";
        overlay.classList.add("active");

        // Tampilkan new-menu-container
        var newMenuContainer = document.querySelector('.new-menu-container');
        newMenuContainer.style.display = 'block';
        newMenuContainer.style.top = '50%';
        newMenuContainer.style.transform = 'translate(-50%, -50%)';
    })

    // Event listener untuk tombol add-menu
    document.querySelector('.add-menu').addEventListener('click', () => {
        // Tampilkan new-menu-container

        // Tampilkan overlay
        const overlay = document.querySelector('.overlay');
        overlay.style.top = "0%";
        overlay.style.opacity = "1";
        overlay.classList.add("active");

        // Tampilkan new-menu-container
        var newMenuContainer = document.querySelector('.new-menu-container');
        newMenuContainer.style.display = 'block';
        newMenuContainer.style.top = '50%';
        newMenuContainer.style.transform = 'translate(-50%, -50%)';
    })

    // Variabel untuk menampung gambar yang akan diunggah
    // Variable to hold the uploaded image
    let queuedImage = null;

    // Event listener for uploading an image
    const dropArea = document.getElementById("drop-area");
    const inputFile = document.getElementById("input-file");
    const imageView = document.getElementById("img-view");

    inputFile.addEventListener("change", uploadImage);

    function uploadImage(){
        // Create a URL for the selected image
        let imgLink = URL.createObjectURL(inputFile.files[0]);
        imageView.style.backgroundImage = `url(${imgLink})`;
        imageView.textContent = "";
        // imageView.style.border = 0;

        // Store the selected image
        queuedImage = inputFile.files[0];
    }

    // Prevent default behavior when dragging over the drop area
    dropArea.addEventListener("dragover", function(e){
        e.preventDefault();
    });

    // Event listener for dropping an image
    dropArea.addEventListener("drop", function(e){
        e.preventDefault();

        // Menambahkan gambar yang di-drop ke dalam queuedImage
        // Add the dropped image to the queue
        uploadImage();
    })

    // Event listener untuk tombol "Save"
    // Event listener for the "Save" button
    const saveButton = document.querySelector(".save-btn-menu");
    saveButton.addEventListener("click", sendQueuedImagesToServer);

    // Function to save the menu to the server
    function saveMenuToServer(path) {
        // Get menu details from the form
        const name = document.querySelector('input[name="name"]').value;
        const image = path;
        const price = document.querySelector('input[name="price"]').value;
        const type = document.querySelector('select[name="type"]').value;

        // Send a POST request to save the menu
        fetch('/menus', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({name: name, price: price, image: image, type: type})
        })

        .then(response => {
            // Reload the page if the request is successful
            if (response.status !== 200) throw Error(response.statusText);
            location.reload();
        })

        .catch(error => {
            console.error("Error:", error);
        })
    }

    // Function to send the queued images to the server
    function sendQueuedImagesToServer() {
        // Pastikan ada gambar yang dipilih sebelum mengirim
        // Ensure an image is selected before sending
        if (!queuedImage) {
            console.error("No image selected.");
            return;
        }

        const formData = new FormData();

        // Menambahkan gambar yanga da di queuedImage ke dalam formData
        // Add the queued image for the FormData object
        formData.append("file", queuedImage);

        // Mengirim formData ke server
        // Send the FormData to the server
        fetch("/dashboard/upload", {
            method: "POST",
            body: formData
        })

        .then(response => {
            // Process the response
            if (response.status !== 200) throw Error(response.statusText);
            return response.text();
        })

        .then(data => {
            // Data di sini akan berisi path file yang dikirim kembali oleh server
            // Concatenate the server response to form the image path
            pathfile = "../assets/menu/uploads/" + data;

            // Save the mnu with the image path
            saveMenuToServer(pathfile);
        })

        .catch(error => {
            // serverMessage.innerHTML = error
            console.error("Error:", error);
        })
    }

    // Event listener untuk tombol edit menu
    // Event listener for the "Edit Menu" button
    document.querySelectorAll('.menu-update').forEach(updateBtn => {
        updateBtn.addEventListener('click', (e) => {
            e.preventDefault();

            // Ambil data menu dari tabel yang sesuai dengan ID yang dipilih
            // Get the menu data from the table row corresponding to the selected ID
            const menuRow = e.currentTarget.closest('tr');
            const menuID = menuRow.querySelector('td:nth-child(1)').textContent.trim();
            const menuIDNumber = parseFloat(menuID)
            console.log(menuIDNumber);
            const menuIDdb = e.currentTarget.getAttribute('update-id');
            console.log(menuIDdb);
            const menuName = menuRow.querySelector('td[data-name]').textContent.trim();
            const menuPrice = menuRow.querySelector('td:nth-child(4)').textContent.trim();
            const priceWithoutCommas = menuPrice.replace(/,/g, ''); // Hilangkan tanda koma
            const menuPriceNumber = parseFloat(priceWithoutCommas);
            const menuType = menuRow.querySelector('td:nth-child(5)').textContent.trim();
            const menuImageSrc = menuRow.querySelector('img').getAttribute('src');

            // Isi formulir update menu dengan data yang relevan
            // Fill the update menu form with relevant data
            document.querySelector('input[name="id2"]').value = menuIDNumber;
            document.querySelector('input[name="name2"]').value = menuName;
            document.querySelector('input[name="price2"]').value = menuPriceNumber;
            document.querySelector('select[name="type2"]').value = menuType;
            document.querySelector('#img-view2').style.backgroundImage = `url(${menuImageSrc})`;

            // Tampilkan overlay
            // Show the overlay
            const overlay = document.querySelector('.overlay');
            overlay.style.top = "0%";
            overlay.style.opacity = "1";
            overlay.classList.add("active");

            // Tampilkan kontainer update menu
            // Show the update menu container
            const updateMenuContainer = document.querySelector('.update-menu-container');
            updateMenuContainer.style.display = 'block';
            updateMenuContainer.style.top = '50%';
            updateMenuContainer.style.transform = 'translate(-50%, -50%)';

            // Set the dataset with the menu ID from the database
            updateMenuContainer.dataset.menuIDdb = menuIDdb;
        });
    });

    // Variabel untuk menampung gambar yang akan diunggah
    // Variable to hold the uploaded image (for updating menu)
    let queuedImage2 = null;

    // Event listener untuk upload image
    // Event listener for uploading an image (for updating menu)
    const dropArea2 = document.getElementById("view-area");
    const inputFile2 = document.getElementById("input-file2");
    const imageView2 = document.getElementById("img-view2");

    inputFile2.addEventListener("change", uploadImage2);

    function uploadImage2(){
        // Create a URL for the selected image
        let imgLink2 = URL.createObjectURL(inputFile2.files[0]);
        imageView2.style.backgroundImage = `url(${imgLink2})`;

        // Store the selected image
        queuedImage2 = inputFile2.files[0];
    }

    // Prevent default behavior when dragging over the drop area
    dropArea2.addEventListener("dragover", function(e){
        e.preventDefault();
    });

    // Event listener for dropping an image
    dropArea2.addEventListener("drop", function(e){
        e.preventDefault();

        // Menambahkan gambar yang di-drop ke dalam queuedImage
        // Add the dropped image to the queue
        uploadImage2();
    })

    // Event listener untuk tombol "Save"
    // Event listener for the "Save" button of update menu
    const saveButton2 = document.querySelector(".save-btn-menu2");

    saveButton2.addEventListener("click", () => {
        if (queuedImage2 === null){
            // If no new image is selected, use the existing one
            var backgroundImageValue = document.querySelector('#img-view2').style.backgroundImage;
            backgroundImage = backgroundImageValue.replace('url("', '').replace('")', '');
            console.log(backgroundImage);

            // Update the menu with the existing image
            updateMenuToServer(backgroundImage);
        }
        else{
            // If a new image is selected, send it to the server
            sendQueuedImagesToServer2();
        }
    });

    // Function to update the menu on the server
    function updateMenuToServer(path) {
        // Select the element by class name and attribute
        const element = document.querySelector('.menu-update[update-id]');

        // Get the value of the update-id attribute
        const id = document.querySelector('.update-menu-container').dataset.menuIDdb;
        const name = document.querySelector('input[name="name2"]').value;
        const image = path;
        const price = document.querySelector('input[name="price2"]').value;
        const type = document.querySelector('select[name="type2"]').value;

        // Create a request body with the menu details
        const requestBody = {
            id: id,
            name: name,
            price: price,
            image: image,
            type: type
        };

        // Send a PUT request to update the menu item
        fetch(`/menus/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            // If the request is successful, reload the page
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json(); // Assuming server responds with JSON
        })
        .then(data => {
            console.log('Menu updated successfully:', data);
            location.reload(); // Reload the page after successful update
        })
        .catch(error => {
            console.error('Error updating menu:', error);
        });
    }

    // Function to send queued images to the server
    function sendQueuedImagesToServer2() {
        // Pastikan ada gambar yang dipilih sebelum mengirim
        // Ensure an image is selected before sending
        if (!queuedImage2) {
            console.error("No image selected.");
            return;
        }

        const formData = new FormData();

        // Menambahkan gambar yanga da di queuedImage ke dalam formData
        // Add the queued image to the FormData object
        formData.append("file", queuedImage2);

        // Mengirim formData ke server
        // Send the FormData to the server
        fetch("/dashboard/upload", {
            method: "POST",
            body: formData
        })

        .then(response => {
            // Process the response
            if (response.status !== 200) throw Error(response.statusText);
            return response.text();
        })

        .then(data => {
            // Data di sini akan berisi path file yang dikirim kembali oleh server
            // Concatenate the server response to form the image path
            pathfile = "../assets/menu/uploads/" + data;

            // Update the menu with the new image path
            updateMenuToServer(pathfile);
        })

        .catch(error => {
            // serverMessage.innerHTML = error
            console.error("Error:", error);
        })
    }

    // Event listener untuk tombol penghapusan
    document.querySelector('.delete-btn').addEventListener('click', () => {
        // Dapatkan ID menu yang akan dihapus dari data di dalam popup konfirmasi
        const menuID = document.querySelector('.delete-menu-container').dataset.menuID;
        // 
        if (menuID) {
            fetch(`/menus/${menuID}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Menu with ID ${menuID} has been deleted.`);
                } else {
                    console.error(`Error deleting menu item. ${menuId}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        } else {
            console.error('Menu ID is undefined.');
        }
        // Sembunyikan overlay
        const overlay = document.querySelector('.overlay');
        overlay.style.top = "-100%";
        overlay.style.opacity = "0";
        // Sembunyikan kontainer penghapusan
        const deleteMenuContainer = document.querySelector('.delete-menu-container');
        deleteMenuContainer.style.display = '150%';
        deleteMenuContainer.style.transform = 'translate(-50%, -50%)';
        deleteMenuContainer.style.display = 'none';
        // REFRESH PAGE SO THAT THE ID IS UPDATED
        window.location.reload();
    });

    // Event listener untuk tombol pembatalan di menu baru
    document.querySelector('.cancel-btn-menu').addEventListener('click', () => {
        // Sembunyikan overlay
        const overlay = document.querySelector('.overlay');
        overlay.style.top = "-100%";
        overlay.style.opacity = "0";

        // Sembunyikan kontainer menu baru
        const newMenuContainer = document.querySelector('.new-menu-container');
        newMenuContainer.style.display = '150%';
        newMenuContainer.style.transform = 'translate(-50%, -50%)';
        newMenuContainer.style.display = 'none';

        window.location.reload();
    });

    // Event listener untuk tombol pembatalan di menu baru
    document.querySelector('.cancel-btn-menu2').addEventListener('click', () => {
        // Sembunyikan overlay
        const overlay = document.querySelector('.overlay');
        overlay.style.top = "-100%";
        overlay.style.opacity = "0";

        // Sembunyikan kontainer menu baru
        const newMenuContainer = document.querySelector('.update-menu-container');
        newMenuContainer.style.display = '150%';
        newMenuContainer.style.transform = 'translate(-50%, -50%)';
        newMenuContainer.style.display = 'none';

        window.location.reload();
    });
</script>